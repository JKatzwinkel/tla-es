plugins {
    id 'war'
    id 'java'
    id 'jacoco'
    // Apply the application plugin to add support for building a CLI application.
    id 'application'
    id 'maven-publish'
    id "co.uzzu.dotenv.gradle" version "1.0.2"
    id 'org.springframework.boot' version '2.2.4.RELEASE'
    id 'com.github.ben-manes.versions' version '0.28.0'
    id 'com.github.dawnwords.jacoco.badge' version '0.2.0'
}

group = 'org.bbaw.aaew.tla'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '11'

publishing {
    publications {
        maven(MavenPublication) {
            artifactId = 'tla-elasticsearch'
            pom {
                name = 'TLA Elasticsearch Backend'
                description = 'Elasticsearch backend for the Thesaurus Linguae Aegyptiae web component'
            }
            from components.java
        }
    }
}

repositories {
    mavenCentral()
    maven { url 'https://repo.spring.io/milestone' }
    maven { url 'https://jitpack.io' }
}

configurations {
    implementation.exclude module: 'spring-boot-starter-jetty'
    implementation.exclude module: 'spring-boot-starter-netty'
    // ES transport client stuff
    implementation.exclude module: 'transport'
    implementation.exclude module: 'transport-netty4-client'
    testImplementation.exclude module: 'junit-vintage-engine'
    testImplementation.exclude group: 'org.junit.vintage'
}

dependencies {
    compileOnly 'org.projectlombok:lombok:1.18.12'
    annotationProcessor 'org.projectlombok:lombok:1.18.12'

    implementation 'com.github.jkatzwinkel:tla-common:master-SNAPSHOT'

    implementation 'org.springframework.data:spring-data-elasticsearch:3.2.4.RELEASE'
    implementation 'org.springframework.boot:spring-boot-starter-web:2.3.0.M1'

    testImplementation 'org.springframework.boot:spring-boot-starter-test:2.2.4.RELEASE'
    // Use JUnit Jupiter Engine for testing.
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.6.0'
}

application {
    // Define the main class for the application.
    mainClassName = 'tla.backend.App'
}

test {
    // Use junit platform for unit tests
    useJUnitPlatform()
    finalizedBy 'jacocoTestReport'
}

jacocoTestReport {
    reports {
        xml.enabled true
        html.enabled true
    }
    finalizedBy 'generateJacocoBadge'
}

bootRun {
    environment "ES_PORT", env.ES_PORT.orElse("9200")
}
