---

name: build

'on':
  push

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version:
          - 17
          - 21

    permissions:
      checks: write
      contents: write

    steps:

      - uses: actions/checkout@v4.1.1

      - uses: actions/setup-java@v4.0.0
        with:
          distribution: temurin
          java-version: ${{ matrix.java-version }}
          cache: gradle

      - uses: gradle/wrapper-validation-action@v1.1.0

      - name: Set up Elasticsearch container
        run: docker compose up -d es
        env:
          ES_PORT: 9200

      - name: Prepare submitting Gradle dependency graph
        uses: gradle/gradle-build-action@v3.0.0-beta.5
        with:
          dependency-graph: generate-and-submit

      - name: Build project
        run: ./gradlew compileTestJava

      - name: Wait for ES to respond
        run: >
          bash .github/scripts/wait_for_response.sh
          http://localhost:9200 30

      - name: Run tests
        run: ./gradlew test

      - name: Process junit reports
        uses: mikepenz/action-junit-report@v4.0.3
        if: always()
        with:
          report_paths: 'build/test-results/test/TEST-*.xml'

...
